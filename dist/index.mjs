var L=class extends Error{constructor(e){super(e);this.name="YoutubeError"}},R=class extends Error{constructor(e){super(e);this.name="UrlError";this.message||(this.message="An invalid url is provided.")}},B=class extends Error{constructor(e){super(e);this.name="FormatError";this.message||(this.message="Cannot find suitable format for this download.")}};import Z from"m3u8stream";import{PassThrough as ee}from"stream";var f="[a-zA-Z_\\$]\\w*",O="'[^'\\\\]*(:?\\\\[\\s\\S][^'\\\\]*)*'",j='"[^"\\\\]*(:?\\\\[\\s\\S][^"\\\\]*)*"',N=`(?:${O}|${j})`,v=`(?:${f}|${N})`,_=`(?:\\.${f}|\\[${N}\\])`,$=`(?:''|"")`,P=":function\\(a\\)\\{(?:return )?a\\.reverse\\(\\)\\}",V=":function\\(a,b\\)\\{return a\\.slice\\(b\\)\\}",H=":function\\(a,b\\)\\{a\\.splice\\(0,b\\)\\}",x=":function\\(a,b\\)\\{var c=a\\[0\\];a\\[0\\]=a\\[b(?:%a\\.length)?\\];a\\[b(?:%a\\.length)?\\]=c(?:;return a)?\\}",M=new RegExp(`var (${f})=\\{((?:(?:${v}${P}|${v}${V}|${v}${H}|${v}${x}),?\\r?\\n?)+)\\};`),Y=new RegExp(`function(?: ${f})?\\(a\\)\\{a=a\\.split\\(${$}\\);\\s*((?:(?:a=)?${f}${_}\\(a,\\d+\\);)+)return a\\.join\\(${$}\\)\\}`),K=new RegExp(`(?:^|,)(${v})${P}`,"m"),G=new RegExp(`(?:^|,)(${v})${V}`,"m"),J=new RegExp(`(?:^|,)(${v})${H}`,"m"),W=new RegExp(`(?:^|,)(${v})${x}`,"m");function D(d,t){let e=t.split("");for(let a of d){let i=Number(a.slice(1));switch(a[0]){case"r":e.reverse();break;case"s":e=e.slice(i);break;case"p":e.splice(0,i);break;case"w":[e[0],e[i%e.length]]=[e[i%e.length],e[0]];break}}return e.join("")}function I(d){let t=M.exec(d),e=Y.exec(d);if(!t||!e)return null;let a=t[1].replace(/\$/g,"\\$"),i=t[2].replace(/\$/g,"\\$"),u=e[1].replace(/\$/g,"\\$"),o=K.exec(i)?.[1].replace(/\$/g,"\\$").replace(/\$|^'|^"|'$|"$/g,""),r=G.exec(i)?.[1].replace(/\$/g,"\\$").replace(/\$|^'|^"|'$|"$/g,""),m=J.exec(i)?.[1].replace(/\$/g,"\\$").replace(/\$|^'|^"|'$|"$/g,""),n=W.exec(i)?.[1].replace(/\$/g,"\\$").replace(/\$|^'|^"|'$|"$/g,""),l=`(${o}|${r}|${m}|${n})`,y=new RegExp(`(?:a=)?${a}(?:\\.${l}|\\[(?:'${l}'|"${l}")\\])\\(a,(\\d+)\\)`,"g"),c=[];for(let p of u.matchAll(y))switch(p[1]||p[2]||p[3]){case o:c.push("r");break;case r:c.push(`s${p[4]}`);break;case m:c.push(`p${p[4]}`);break;case n:c.push(`w${p[4]}`);break}return c}var F={5:{mimeType:'video/flv; codecs="Sorenson H.263, mp3"',qualityLabel:"240p",bitrate:25e4,audioBitrate:64},6:{mimeType:'video/flv; codecs="Sorenson H.263, mp3"',qualityLabel:"270p",bitrate:8e5,audioBitrate:64},13:{mimeType:'video/3gp; codecs="MPEG-4 Visual, aac"',qualityLabel:null,bitrate:5e5,audioBitrate:null},17:{mimeType:'video/3gp; codecs="MPEG-4 Visual, aac"',qualityLabel:"144p",bitrate:5e4,audioBitrate:24},18:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"360p",bitrate:5e5,audioBitrate:96},22:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"720p",bitrate:2e6,audioBitrate:192},34:{mimeType:'video/flv; codecs="H.264, aac"',qualityLabel:"360p",bitrate:5e5,audioBitrate:128},35:{mimeType:'video/flv; codecs="H.264, aac"',qualityLabel:"480p",bitrate:8e5,audioBitrate:128},36:{mimeType:'video/3gp; codecs="MPEG-4 Visual, aac"',qualityLabel:"240p",bitrate:175e3,audioBitrate:32},37:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"1080p",bitrate:3e6,audioBitrate:192},38:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"3072p",bitrate:35e5,audioBitrate:192},43:{mimeType:'video/webm; codecs="VP8, vorbis"',qualityLabel:"360p",bitrate:5e5,audioBitrate:128},44:{mimeType:'video/webm; codecs="VP8, vorbis"',qualityLabel:"480p",bitrate:1e6,audioBitrate:128},45:{mimeType:'video/webm; codecs="VP8, vorbis"',qualityLabel:"720p",bitrate:2e6,audioBitrate:192},46:{mimeType:'audio/webm; codecs="VP8, vorbis"',qualityLabel:"1080p",bitrate:null,audioBitrate:192},82:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"360p",bitrate:5e5,audioBitrate:96},83:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"240p",bitrate:5e5,audioBitrate:96},84:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"720p",bitrate:2e6,audioBitrate:192},85:{mimeType:'video/mp4; codecs="H.264, aac"',qualityLabel:"1080p",bitrate:3e6,audioBitrate:192},91:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"144p",bitrate:1e5,audioBitrate:48},92:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"240p",bitrate:15e4,audioBitrate:48},93:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"360p",bitrate:5e5,audioBitrate:128},94:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"480p",bitrate:8e5,audioBitrate:128},95:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"720p",bitrate:15e5,audioBitrate:256},96:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"1080p",bitrate:25e5,audioBitrate:256},100:{mimeType:'audio/webm; codecs="VP8, vorbis"',qualityLabel:"360p",bitrate:null,audioBitrate:128},101:{mimeType:'audio/webm; codecs="VP8, vorbis"',qualityLabel:"360p",bitrate:null,audioBitrate:192},102:{mimeType:'audio/webm; codecs="VP8, vorbis"',qualityLabel:"720p",bitrate:null,audioBitrate:192},120:{mimeType:'video/flv; codecs="H.264, aac"',qualityLabel:"720p",bitrate:2e6,audioBitrate:128},127:{mimeType:'audio/ts; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:96},128:{mimeType:'audio/ts; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:96},132:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"240p",bitrate:15e4,audioBitrate:48},133:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"240p",bitrate:2e5,audioBitrate:null},134:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"360p",bitrate:3e5,audioBitrate:null},135:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"480p",bitrate:5e5,audioBitrate:null},136:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"720p",bitrate:1e6,audioBitrate:null},137:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"1080p",bitrate:25e5,audioBitrate:null},138:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"4320p",bitrate:135e5,audioBitrate:null},139:{mimeType:'audio/mp4; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:48},140:{mimeType:'audio/m4a; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:128},141:{mimeType:'audio/mp4; codecs="aac"',qualityLabel:null,bitrate:null,audioBitrate:256},151:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"720p",bitrate:5e4,audioBitrate:24},160:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"144p",bitrate:1e5,audioBitrate:null},171:{mimeType:'audio/webm; codecs="vorbis"',qualityLabel:null,bitrate:null,audioBitrate:128},172:{mimeType:'audio/webm; codecs="vorbis"',qualityLabel:null,bitrate:null,audioBitrate:192},242:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"240p",bitrate:1e5,audioBitrate:null},243:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"360p",bitrate:25e4,audioBitrate:null},244:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"480p",bitrate:5e5,audioBitrate:null},247:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"720p",bitrate:7e5,audioBitrate:null},248:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1080p",bitrate:15e5,audioBitrate:null},249:{mimeType:'audio/webm; codecs="opus"',qualityLabel:null,bitrate:null,audioBitrate:48},250:{mimeType:'audio/webm; codecs="opus"',qualityLabel:null,bitrate:null,audioBitrate:64},251:{mimeType:'audio/webm; codecs="opus"',qualityLabel:null,bitrate:null,audioBitrate:160},264:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"1440p",bitrate:4e6,audioBitrate:null},266:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"2160p",bitrate:125e5,audioBitrate:null},271:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1440p",bitrate:9e6,audioBitrate:null},272:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"4320p",bitrate:2e7,audioBitrate:null},278:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"144p 30fps",bitrate:8e4,audioBitrate:null},298:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"720p",bitrate:3e6,audioBitrate:null},299:{mimeType:'video/mp4; codecs="H.264"',qualityLabel:"1080p",bitrate:55e5,audioBitrate:null},300:{mimeType:'video/ts; codecs="H.264, aac"',qualityLabel:"720p",bitrate:1318e3,audioBitrate:48},302:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"720p HFR",bitrate:25e5,audioBitrate:null},303:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1080p HFR",bitrate:5e6,audioBitrate:null},308:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1440p HFR",bitrate:1e7,audioBitrate:null},313:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"2160p",bitrate:13e6,audioBitrate:null},315:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"2160p HFR",bitrate:2e7,audioBitrate:null},330:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"144p HDR, HFR",bitrate:8e4,audioBitrate:null},331:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"240p HDR, HFR",bitrate:1e5,audioBitrate:null},332:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"360p HDR, HFR",bitrate:25e4,audioBitrate:null},333:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"240p HDR, HFR",bitrate:5e5,audioBitrate:null},334:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"720p HDR, HFR",bitrate:1e6,audioBitrate:null},335:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1080p HDR, HFR",bitrate:15e5,audioBitrate:null},336:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"1440p HDR, HFR",bitrate:5e6,audioBitrate:null},337:{mimeType:'video/webm; codecs="VP9"',qualityLabel:"2160p HDR, HFR",bitrate:12e6,audioBitrate:null}};var s=class s extends null{static async fetchConfig(){try{let t=await fetch("https://www.youtube.com/?hl=en"),e=JSON.parse(/ytcfg.set\(({.+?})\);/s.exec(await t.text())[1]);if(s.INNERTUBE_API_KEY=e.INNERTUBE_API_KEY,s.INNERTUBE_API_VERSION=e.INNERTUBE_API_VERSION,s.INNERTUBE_CONTEXT.client.clientName=s.INNERTUBE_CLIENT_NAME=e.INNERTUBE_CLIENT_NAME,s.INNERTUBE_CONTEXT.client.clientVersion=s.INNERTUBE_CLIENT_VERSION=e.INNERTUBE_CLIENT_VERSION,s.STS=e.STS,s.PLAYER_JS_URL!==e.PLAYER_JS_URL){let i=await(await fetch(`https://www.youtube.com${e.PLAYER_JS_URL}`)).text();s.PLAYER_JS_URL=e.PLAYER_JS_URL,s.PLAYER_TOKENS=I(i)}setTimeout(s.fetchConfig,120*60*1e3)}catch{}}};s.INNERTUBE_API_KEY="AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8",s.INNERTUBE_API_VERSION="v1",s.INNERTUBE_CLIENT_NAME="WEB",s.INNERTUBE_CLIENT_VERSION="2.20231012.01.03",s.INNERTUBE_CONTEXT={client:{clientName:"IOS_MUSIC",clientVersion:"6.33.3",deviceModel:"iPhone14,3",userAgent:"com.google.ios.youtubemusic/6.33.3 (iPhone14,3; U; CPU iOS 15_6 like Mac OS X)"}},s.STS=0,s.PLAYER_JS_URL="",s.PLAYER_TOKENS=null;var b=s;b.fetchConfig();import z from"m3u8-parser";var U=/^[\w-]{11}$/,Q=/^https?:\/\/(youtu\.be\/|(www\.)?youtube\.com\/(embed|v|shorts)\/)/,X=["youtube.com","www.youtube.com","m.youtube.com","music.youtube.com"],h=class extends null{static getVideoURL(t){return`https://www.youtube.com/watch?v=${t}`}static getApiURL(t){return`https://www.youtube.com/youtubei/v1/${t}?key=${b.INNERTUBE_API_KEY}`}static getVideoId(t,e=!1){try{if(U.test(t)&&!e)return t;let a=new URL(t),i=a.searchParams.get("v");if(Q.test(t)&&!i)i=a.pathname.split("/")[a.hostname==="youtu.be"?1:2].slice(0,11);else if(!X.includes(a.hostname))return null;return U.test(i??"")?i:null}catch{return null}}static getMetadataFormat(t){return t.hasVideo=!!t.qualityLabel,t.hasAudio=!!t.audioBitrate,t.isLive=/\bsource[/=]yt_(live|premiere)_broadcast\b/.test(t.url),t.isHLS=/\/manifest\/hls_(variant|playlist)\//.test(t.url),t.isDashMPD=/\/manifest\/dash\//.test(t.url),t}static async GetHLSFormats(t){let e=[];try{let i=await fetch(t);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);let u=await i.text();if(!u)throw new Error("No response body");var a=new z.Parser;a.push(u),a.end();let o=a.manifest,r=o.mediaGroups.AUDIO||{},m={};for(let n in r)for(let l in r[n]){let y=r[n][l],c=parseInt(y.uri.match(/itag\/(\d+)/)[1]);m[n]={itag:c,mimeType:"audio/mp4",qualityLabel:null,bitrate:null,audioBitrate:null,codec:y.codecs,type:"audio",url:y.uri,hasAudio:!0,hasVideo:!1,isLive:!1,isHLS:!0,isDashMPD:!1}}for(let n of o.playlists){let l=n.attributes,y=parseInt(n.uri.match(/itag\/(\d+)/)[1]),c=l.AUDIO,p={itag:y,mimeType:`video/mp4; codecs="${l.CODECS}"`,qualityLabel:`${l.RESOLUTION.height}p`,bitrate:l.BANDWIDTH,audioBitrate:null,codec:l.CODECS,type:"video",width:l.RESOLUTION.width,height:l.RESOLUTION.height,fps:l["FRAME-RATE"],url:n.uri,hasAudio:!!c,hasVideo:!0,isLive:!1,isHLS:!0,isDashMPD:!1};c&&m[c]&&(p.audioBitrate=m[c].audioBitrate),e.push(p)}for(let n in m)e.some(l=>l.url===m[n].url)||e.push(m[n])}catch(i){return console.error("Error fetching or parsing the HLS formats:",i),[]}return e}};async function A(d,t=!1,e){let a=h.getVideoId(d);if(!a)throw new R;let u=await(await fetch(h.getApiURL("player"),{method:"POST",body:JSON.stringify({context:b.INNERTUBE_CONTEXT,videoId:a,playbackContext:{contentPlaybackContext:{vis:0,splay:!1,autoCaptionsDefaultOn:!1,autonavState:"STATE_NONE",html5Preference:"HTML5_PREF_WANTS",lactMilliseconds:"-1",signatureTimestamp:b.STS}}}),proxy:e?`http://${e.Host}:${e.Port}`:void 0,tls:{rejectUnauthorized:!1}})).json();if(u.playabilityStatus?.status==="ERROR")throw new L(u.playabilityStatus.reason);let o=new E(u);if(t){let r=u.streamingData?.hlsManifestUrl;if(r){let m=await h.GetHLSFormats(r);o.liveFormats.push(...m)}}return o}async function C(d,t){return(await A(d,!0)).Download(a=>a.isHLS||a.codec==="opus"&&!a.hasVideo&&a.hasAudio,t)}import{HttpsProxyAgent as te}from"https-proxy-agent";var E=class{constructor(t){this.liveFormats=[];this.normalFormats=[];this.json=t,this.addFormats([...t.streamingData?.formats??[],...t.streamingData?.adaptiveFormats??[]])}get url(){return h.getVideoURL(this.json.videoDetails.videoId)}get details(){return{id:this.json.videoDetails.videoId,url:h.getVideoURL(this.json.videoDetails.videoId),title:this.json.videoDetails.title,thumbnails:this.json.videoDetails.thumbnail.thumbnails,description:this.json.videoDetails.shortDescription,duration:Number(this.json.videoDetails.lengthSeconds)*1e3,viewCount:Number(this.json.videoDetails.viewCount),author:this.json.videoDetails.author,channelId:this.json.videoDetails.channelId,keywords:this.json.videoDetails.keywords,allowRatings:this.json.videoDetails.allowRatings,averageRating:this.json.videoDetails.averageRating,isOwnerViewing:this.json.videoDetails.isOwnerViewing,isCrawlable:this.json.videoDetails.isCrawlable,isUnpluggedCorpus:this.json.videoDetails.isUnpluggedCorpus,isPrivate:this.json.videoDetails.isPrivate,isLiveContent:this.json.videoDetails.isLiveContent,formats:this.formats}}get formats(){return[...this.liveFormats,...this.normalFormats]}Download(t,e={},a){let i=this.formats.filter(r=>r.isHLS||r.contentLength&&(r.hasVideo||r.hasAudio)),u=i.filter(t),o=u[u.length-1]??i[i.length-1];if(!o)throw new B;if(o.isHLS){let r=Z(o.url,{id:String(o.itag),parser:"m3u8",highWaterMark:e.highWaterMark??65536,begin:e.begin??(o.isLive?Date.now():0),liveBuffer:e.liveBuffer??4e3,requestOptions:{maxReconnects:1/0,maxRetries:10,backoff:{inc:20,max:100},agent:a?new te(`http://${a.Host}:${a.Port}`):void 0}});return r.once("close",()=>{r.end()}),r}else{let r=e.chunkSize??262144,m=e.remainRetry??10,n=e.start??0,l=n+r,y=null,c=null,p=null,g=e.resource??new ee({highWaterMark:e.highWaterMark??64*1024}).on("drain",()=>{y?.(),y=null}).once("close",()=>{c?.destroy(),c=null,clearTimeout(p),p=null}),S=async()=>{try{let T=await fetch(o.url,{headers:{range:`bytes=${n}-${l>=o.contentLength?"":l}`,referer:"https://www.youtube.com/"},redirect:"follow",proxy:a?`http://${a.Host}:${a.Port}`:void 0,tls:{rejectUnauthorized:!1}});if(!T.ok){T.status===403&&m>0?(e.resource=g,e.start=n,e.remainRetry=m-1,p=setTimeout(C,150,this.url,e)):g.destroy(new Error(`Cannot retry download with status code ${T.status}`));return}let q=T.body?.getReader();if(!q)throw new Error("Cannot get readable stream from response body.");let w=await q.read();for(;!w.done;){if(g.destroyed)return;n+=w.value.length,g.write(w.value)||await new Promise(k=>g.once("drain",k)),w=await q.read()}if(g.destroyed||n>=o.contentLength)return;l=n+r,S()}catch(T){g.destroy(T)}};return S(),g}}addFormats(t){for(let e of t){let a=e.itag,i=F[a];if(i){let u=e.mimeType??i.mimeType,o={itag:a,mimeType:u,codec:u.split('"')[1],type:u.split(";")[0],qualityLabel:e.qualityLabel??i.qualityLabel,bitrate:e.bitrate??i.bitrate,audioBitrate:i.audioBitrate,width:e.width,height:e.height,initRange:{start:Number(e.initRange?.start),end:Number(e.initRange?.end)},indexRange:{start:Number(e.indexRange?.start),end:Number(e.indexRange?.end)},lastModifiedTimestamp:Number(e.lastModified),contentLength:Number(e.contentLength),quality:e.quality,fps:e.fps,projectionType:e.projectionType,averageBitrate:e.averageBitrate,approxDurationMs:Number(e.approxDurationMs),signatureCipher:e.signatureCipher??e.cipher};e.url&&!o.signatureCipher?o.url=e.url:!e.url&&o.signatureCipher&&(o={...o,...Object.fromEntries(new URLSearchParams(o.signatureCipher))});let r=new URL(o.url);r.searchParams.set("ratebypass","yes"),b.PLAYER_TOKENS&&o.s&&r.searchParams.set(o.sp??"signature",D(b.PLAYER_TOKENS,o.s)),o.url=r.toString(),this.normalFormats.push(h.getMetadataFormat(o))}}}};export{C as Download,B as FormatError,A as GetVideo,R as UrlError,h as Util,b as YoutubeConfig,L as YoutubeError,E as YoutubeVideo,F as formats};
//# sourceMappingURL=index.mjs.map